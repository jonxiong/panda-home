# EventLoop

- [EventLoop](#eventloop)
  - [前言](#前言)
  - [栈和队列的基本概念](#栈和队列的基本概念)
    - [栈（Stack）](#栈stack)
    - [队列（Queue）](#队列queue)
    - [eventloop](#eventloop-1)
      - [宏任务](#宏任务)
      - [微任务](#微任务)
  - [浏览器中的Event loop](#浏览器中的event-loop)
    - [同步任务和异步任务](#同步任务和异步任务)

## 前言

`Event Loop` 即事件循环，是指浏览器或 `Node` 的一种解决 `javaScript` 单线程运行时不会阻塞的一种机制，也就是我们经常使用异步的原理。

## 栈和队列的基本概念

### 栈（Stack）
**栈**在计算机科学中是限定仅在**表尾**进行**插入**或**删除**操作的线性表。 栈是一种**数据结构**，它按照**后进先出先进后出**的原则存储数据，先进入的数据被压入栈底，最后的数据在栈顶，需要读数据的时候从**栈顶**开始弹出数据。
栈是只能在**某一端插入和删除**的特殊线性表。

### 队列（Queue）

特殊之处在于它只允许在**表的前端（front）进行删除操作**，而在**表的后端（rear）进行插入操作**，和栈一样，队列是一种操作受限制的线性表。
队列的数据元素又称为**队列元素**。在队列中插入一个队列元素称为**入队**，从队列中删除一个队列元素称为**出队**。因为队列只允许在一端插入，在另一端删除，所以只有最早进入队列的元素才能最先从队列中删除，故队列又称为**先进先出（FIFO—first in first out）**

### eventloop

在 `JavaScript` 中，任务被分为两种，一种**宏任务**（MacroTask）也叫Task，一种叫**微任务**（MicroTask）。

#### 宏任务

`script(整体代码)` 、 `setTimeout` 、 `setInterval` 、 `I/O` 、 `UI 交互事件` 、 `postMessage` 、 `MessageChannel` 、 `setImmediate(Node.js 环境)` 

#### 微任务

`Process.nextTick（Node独有）` 、 `Promise.then` 、 `MutationObserver` 

## 浏览器中的Event loop

`Javascript` 有一个 `main thread` 主线程和 `call-stack` 调用栈(执行栈)，所有的任务都会被放到调用栈等待主线程执行。

### 同步任务和异步任务

`Javascript` 单线程任务被分为**同步任务**和**异步任务**，同步任务会在调用栈中按照顺序等待主线程依次执行，异步任务会在异步任务有了结果后，将注册的回调函数放入任务队列中等待主线程空闲的时候（调用栈被清空），被读取到栈内等待主线程的执行。
任务队列 `Task Queue` ，即队列，是一种**先进先出**的一种数据结构

执行栈在执行完**同步任务**后，查看执行栈是否为空，如果执行栈为空，就会去检查**微任务**(microTask)队列是否为空，如果为空的话，就执**宏任务**，否则就一次性执行完所有微任务。
**每次单个宏任务**执行完毕后，检查**微任务**(microTask)队列是否为空，如果不为空的话，会按照**先入先出**的规则全部执行完**微任务**(microTask)后，设置**微任务**(microTask)队列为null，然后再执行**宏任务**，如此循环。

1. 函数入栈，当Stack中执行到异步任务的时候，就将他丢给WebAPIs,接着执行同步任务,直到Stack为空；
2. 此期间WebAPIs完成这个事件，把回调函数放入队列中等待执行（微任务放到微任务队列，宏任务放到宏任务队列）
3. 执行栈为空时，Event Loop把微任务队列执行清空；
4. 微任务队列清空后，进入宏任务队列，取队列的第一项任务放入Stack(栈）中执行，回到第1步

[参考文章](https://juejin.im/post/5e0adffbe51d4541013f0bf4)
