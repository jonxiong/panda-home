# 小程序与PWA

- [小程序与PWA](#小程序与pwa)
  - [小程序](#小程序)
    - [小程序基本原理](#小程序基本原理)
    - [小程序特点](#小程序特点)
    - [小程序架构](#小程序架构)
    - [小程序优点](#小程序优点)
    - [小程序存在的问题](#小程序存在的问题)
    - [小程序面试问题](#小程序面试问题)
    - [小程序的优化点](#小程序的优化点)
  - [pwa](#pwa)
  - [h5与原生app交互原理](#h5与原生app交互原理)
  - [webAssembly](#webassembly)
  - [websocket](#websocket)

## 小程序

### 小程序基本原理

### 小程序特点

* 基于微信跨平台
* 即用即走，随手可得
* 拥有离线能力
* 拥有 native 和跨端（不同操作系统）的能力
* 媲美原生操作体验

### 小程序架构

* View视图层： 渲染页面结构
* AppServer逻辑层：逻辑层将数据进行处理后发送给视图层，同时接受视图层的事件反馈
  + App()小程序的入口；Page()页面的入口
  + 提供丰富的 API，如微信用户数据，扫一扫，支付等微信特有能力
  + 每个页面有独立的作用域，并提供模块化能力
  + 数据绑定、事件分发、生命周期管理、路由管理

> 视图层使用WebView渲染，逻辑层使用JSCore运行，两个主要部分独立运行

> 视图层和逻辑层通过系统层的JSBridage进行通信，逻辑层把数据变化通知到视图层，触发视图层页面更新，视图层把触发的事件通知到逻辑层进行业务处理

![0](https://user-gold-cdn.xitu.io/2017/1/14/45dc93cb00e30544c7e90c28fa635730?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

> 小程序初始化时，先从微信的CDN下载小程序的完整的包，然后在微信内部进行解包初始化

![1](https://user-gold-cdn.xitu.io/2017/1/14/7f05886d07461131cc6061b2bb8b7a0e?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

### 小程序优点

* 提前新建WebView，准备新页面渲染
* View层和逻辑层分离，通过数据驱动，不直接操作DOM
* 使用Virtual DOM，进行局部更新
* 全部使用https，确保传输中安全
* 使用离线能力
* 前端组件化开发
* 加入rpx单位，隔离设备尺寸，方便开发

### 小程序存在的问题

* 小程序仍然使用WebView渲染，并非原生渲染
* 需要独立开发，不能再非微信环境运行
* 开发者不可以扩展新组件
* 服务端口返回的头无法执行，如Set-Cookie
* 以来浏览器环境的js库不能使用，因为是JSCore执行的，没有window、document对象
* WXSS中无法使用本地（图片、字体等）
* WXSS转化成js而不是css, 为了兼容rpx
* WXSS不支持级联选择器
* 小程序无法打开页面，无法拉起AP

### 小程序面试问题

* 小程序的多线程架构
* 多个 webview 是如何和 JS 线程通信的
* JS 线程又是如何和 native 通信的
* 为什么会感觉小程序打开快
    - 微信**Native**会预先加载一个**WebView**
    - 当打开指定页面时，用默认数据直接渲染，请求数据回来时局部更新
    - 返回显示历史View
    - 退出小程序，View状态不销毁

### 小程序的优化点
1. 控制代码包大小
- 资源控制
 - 开启开发工具”上传代码时自动压缩”，小程序开发工具有一个上传代码时自动压缩的功能，当开启时，会在你上传代码时为你做代码压缩，除了这个，我们也可以通过使用第三方打包工具做代码压缩，如webpack、grunt、grulp。
 - 及时清理无用代码和资源文件，无用的代码和资源也会占用一定的包大小。
 - 减少代码包中的资源文件，将资源存放在cdn上，小程序开发工具对资源文件的压缩比率非常低，资源有条件的可以尽量放在CDN上，因为小程序开发工具对资源文件的压缩比率非常低，只有10%左右，或者也可以用第三编译工具对资源文件自己进行压缩处
- 分包加载
2. 首屏加载性能优化
- 提前请求：异步数据数据请求不需要等待页面渲染完成
- 利用缓存：利用storage API对异步请求数据进行缓存，二次启动时先利用缓存数据渲染页面，再进行后台更新
- 避免白屏：先展示页面骨架和基础内容
- 及时反馈：及时地对需要用户等待的交互操作给出反馈，避免用户以为小程序没有响应
3. 避免不当使用setData
是在data中只定义与页面渲染相关的数据，其他与页面渲染无关的数据都定义成普通变量，在做setData操作时，尽量只传输页面渲染需要的数据，当页面切换时，将后台执行的setData操作销毁，等到页面重新展示的时候再执行。



1. 
2. 页面图片过多：小程序对用户内存使用进行了限制，如果一个页面的图片过多，会导致内存不足的内部错误，导致应用直接崩溃。解决方法，懒加载
3. 


## pwa

> 脱离微信的“小程序”

## [h5与原生app交互原理](https://segmentfault.com/a/1190000016759517)

## webAssembly

## websocket
